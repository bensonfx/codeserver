version: "2.2"
services:
  gerrit:
    build: "image"
    image: "bensonfx/gerrit:2.15.3"
    restart: unless-stopped
    hostname: "review.example.com"
    depends_on:
      - ldap
    environment:
      TZ: "Asia/Shanghai"
    ports:
      - "29418:29418"
    volumes:
      - ./wwwroot/review_site:/var/gerrit/review_site
    mem_limit: 4096M
  ldap:
    image: osixia/openldap
    domainname: "ldap.example.com"
    hostname: "ldap.example.com"
    ports:
      - "389:389"
      - "636:636"
    restart: unless-stopped
    environment:
      TZ: "Asia/Shanghai"
      LDAP_ORGANISATION: "Your Comany"
      LDAP_DOMAIN: "example.com"
      LDAP_ADMIN_PASSWORD: "your_ldap_password"
      LDAP_CONFIG_PASSWORD: "your_ldap_passwrd"
      LDAP_BACKEND: "mdb"
      LDAP_TLS_CRT_FILENAME: "ldap.crt"
      LDAP_TLS_KEY_FILENAME: "ldap.key"
      LDAP_TLS_CA_CRT_FILENAME: "ca.crt"
    volumes:
      - ./wwwroot/ldap/database:/var/lib/ldap
      - ./wwwroot/ldap/config:/etc/ldap/slapd.d
      - ./wwwroot/certificates:/container/service/slapd/assets/certs
  proxy:
    image: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./wwwroot/nginx/conf.d:/etc/nginx/conf.d
      - ./wwwroot/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./wwwroot/nginx/fastcgi.conf:/etc/nginx/fastcgi.conf
      - ./wwwroot/nginx/cache:/var/cache/nginx
      - ./wwwroot/nginx/ssl:/etc/nginx/ssl
      - ./wwwroot/nginx/wwwlogs:/wwwlogs
      - ./wwwroot/lam:/wwwroot
  lam:
    build: lam
    image: bensonfx/lam
    volumes:
      - ./wwwroot/lam:/wwwroot
    working_dir: /wwwroot
